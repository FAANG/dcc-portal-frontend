#version: "3"
#services:
#  faang-frontend:
#    image: "${GCR_HOSTNAME}/${PROJECT_ID}/${REPO_NAME}/${SERVICE_NAME}:${TAG}"
#    build:
#      context: .
#      dockerfile: faang-SSR-false.dockerfile
#    ports:
#      - '80:8080'
#  cypress:
#    image: faang-cypress-tests
#    build:
#      context: .
#      dockerfile: faang-cypress.dockerfile
#    depends_on:
#      - faang-frontend
#    network_mode: 'host'
#
#networks:
#  default:
#    external:
#      name: cloudbuild




version: "3"
services:
  faang-frontend:
    image: "${GCR_HOSTNAME}/${PROJECT_ID}/${REPO_NAME}/${SERVICE_NAME}:${TAG}"
    build:
      context: .
      dockerfile: faang-SSR-false.dockerfile
    ports:
      - "8080:8080"
    networks:
      - cloudbuild
    healthcheck:   # Add a health check for Cypress to wait for readiness
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 5s
      retries: 5

  cypress:
    image: faang-cypress-tests
    build:
      context: .
      dockerfile: faang-cypress.dockerfile
    depends_on:
      faang-frontend:
        condition: service_healthy  # Wait for frontend to be ready
    networks:
      - cloudbuild
    environment:
      - CYPRESS_baseUrl=http://faang-frontend:8080  # Correct frontend URL
    command: ["cypress", "run", "--browser", "chrome", "--no-sandbox"]

networks:
  cloudbuild:
    driver: bridge
